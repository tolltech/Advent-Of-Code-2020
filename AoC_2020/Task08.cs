using System;
using System.Collections.Generic;
using System.Linq;
using NUnit.Framework;

namespace AoC_2020
{
    [TestFixture]
    public class Task08
    {
        public class Prog
        {
            private int acc = 0;

            private (string Op, int Arg)[] ops = Array.Empty<(string Op, int Arg)>();

            public Prog SetCode(string[] lines)
            {
                ops = lines
                    .Select(x => x.Split(" ", StringSplitOptions.RemoveEmptyEntries))
                    .Select(x => (Op: x[0], Arg: int.Parse(x[1])))
                    .ToArray();

                return this;
            }

            public int Execute()
            {
                var index = 0;
                var pastOps = new HashSet<(string Op, int Index)>();
                while (true)
                {
                    var op = ops[index];

                    var opHash = (op.Op, index);
                    if (pastOps.Contains(opHash))
                    {
                        return acc;
                    }

                    pastOps.Add(opHash);

                    switch (op.Op)
                    {
                        case "Acc": acc += op.Arg; break;
                        case "jmp": index += op.Arg; continue;
                        case "nop":  break;
                        default:throw new NotImplementedException("OpCode");
                    }

                    ++index;
                }
            }
        }

        [Test]
        [TestCaseSource(nameof(TestCases))]
        public int Task(string input)
        {
            var lines = input.Split(new[] {"\r\n"}, StringSplitOptions.RemoveEmptyEntries);

            return new Prog().SetCode(lines).Execute();
        }

        private static IEnumerable<TestCaseData> TestCases()
        {
            yield return new TestCaseData(@"nop +0
Acc +1
jmp +4
Acc +3
jmp -3
Acc -99
Acc +1
jmp -4
Acc +6").Returns(0);
            yield return new TestCaseData(@"jmp +1
Acc -15
Acc +14
Acc +18
jmp +443
jmp +286
Acc +27
jmp +522
jmp +1
Acc -19
Acc +22
Acc +37
jmp +111
Acc +28
Acc +43
Acc +18
nop +597
jmp +479
jmp +604
jmp +499
Acc +0
Acc +22
Acc +13
jmp +566
Acc -12
Acc +0
nop +153
jmp +173
jmp +192
jmp +292
Acc +36
Acc +7
jmp +440
Acc -17
Acc +40
Acc +24
Acc -7
jmp +519
nop +16
Acc +15
Acc +42
jmp +445
jmp +350
Acc +42
Acc +12
Acc +2
jmp +133
Acc +12
Acc +3
Acc +27
jmp +186
Acc +25
Acc +46
jmp +285
Acc +32
Acc -11
Acc -6
jmp +565
nop +215
Acc +1
Acc +35
jmp +1
jmp +502
Acc +27
Acc +19
Acc -8
Acc -8
jmp +531
jmp -21
nop +292
Acc +8
Acc -13
jmp +26
Acc +1
Acc +45
nop -42
jmp +323
jmp +39
jmp +336
Acc +19
jmp -51
Acc +45
Acc +26
jmp +278
jmp +6
Acc +40
nop +271
Acc -10
nop -4
jmp +272
nop -61
Acc +4
Acc -14
Acc +27
jmp -70
Acc -9
Acc +29
jmp +416
Acc +25
Acc +45
jmp +19
jmp +39
Acc -19
Acc +7
jmp +248
Acc +11
Acc +36
jmp +515
Acc +45
Acc +49
jmp +329
Acc +30
Acc +31
Acc +28
Acc +26
jmp +8
jmp +283
Acc +32
jmp +127
Acc +4
Acc +20
jmp +92
jmp +50
jmp +133
Acc +5
Acc +8
jmp +313
Acc +38
Acc +34
jmp +395
Acc +14
Acc +29
jmp +392
nop +246
jmp +374
nop +429
nop +388
Acc +3
Acc +0
jmp +432
Acc -1
Acc +35
Acc +35
jmp +148
Acc +8
Acc +11
Acc +12
Acc -10
jmp +434
Acc -19
jmp +330
nop +329
Acc +30
jmp +239
Acc -6
jmp -136
jmp +418
nop +385
jmp +1
Acc +34
Acc +9
jmp +410
nop -13
Acc +31
Acc +15
Acc +37
jmp -142
jmp +109
Acc -16
nop +405
nop +343
jmp +8
Acc +44
Acc -15
Acc +7
Acc +9
jmp +185
Acc +6
jmp +35
nop -25
jmp +93
Acc +22
Acc -17
Acc +15
Acc +39
jmp +41
nop -123
Acc +15
Acc +6
jmp -35
Acc +48
jmp +422
Acc -7
nop +67
nop +66
Acc +48
jmp -29
Acc -11
Acc +16
jmp +92
Acc +45
jmp +92
jmp +212
Acc -3
Acc -18
nop -186
nop +7
jmp -28
nop +292
Acc +7
nop -120
Acc +46
jmp +48
Acc -3
Acc -16
Acc +50
jmp -44
Acc -2
Acc -11
jmp +236
jmp +344
Acc +33
Acc +44
Acc +39
nop -45
jmp -53
Acc -11
nop +380
Acc +35
jmp +113
nop +203
Acc +40
jmp +167
Acc +44
jmp +394
jmp +229
jmp -167
jmp -204
Acc +21
Acc +49
jmp +25
Acc -19
Acc -17
Acc +44
jmp -11
Acc +40
Acc +12
jmp +253
Acc +21
jmp +349
jmp +285
Acc +0
nop +261
Acc +15
Acc +38
jmp +10
Acc +27
jmp +1
jmp +373
jmp -151
Acc +6
jmp -48
Acc +14
Acc -8
jmp -61
Acc +8
Acc +20
jmp +1
jmp +1
jmp +208
Acc -18
Acc +32
jmp +94
jmp +262
Acc +0
jmp -156
nop +188
nop +312
Acc +21
Acc +6
jmp -123
Acc +47
jmp +316
Acc +25
nop +290
jmp +62
Acc -7
Acc +36
nop +212
Acc +14
jmp +332
jmp +291
jmp +226
Acc +30
jmp -161
Acc +39
Acc +38
jmp +203
nop +63
nop -6
Acc -15
nop -56
jmp +72
Acc +1
Acc +34
Acc +22
Acc +19
jmp -135
Acc +27
jmp -303
Acc +1
Acc +48
Acc -19
jmp +142
Acc +50
jmp +298
Acc +43
Acc +0
Acc +50
Acc +12
jmp +137
Acc +41
nop +252
jmp -310
Acc +13
Acc +34
Acc -15
Acc +43
jmp +236
Acc +5
Acc -8
Acc +25
Acc +45
jmp +153
Acc -12
Acc +31
Acc -1
jmp +120
jmp +236
Acc +38
nop -238
jmp -328
jmp +81
Acc +48
Acc +15
Acc -9
jmp -73
nop -49
jmp -271
Acc -17
Acc -17
jmp +106
nop +212
jmp -290
Acc +36
nop +109
jmp +186
jmp -310
Acc +4
Acc +16
jmp +117
jmp +1
Acc +10
jmp +20
Acc +12
jmp -311
Acc +12
Acc +30
nop +182
jmp -315
Acc +25
Acc +12
Acc +30
jmp +50
Acc -19
jmp -333
Acc +30
nop +87
jmp -199
Acc +8
jmp +112
Acc -8
jmp -313
Acc +7
Acc +32
jmp +1
jmp +230
Acc +25
Acc +45
Acc +20
Acc +0
jmp -307
Acc +30
nop -253
Acc +7
Acc +39
jmp -113
Acc -12
jmp +209
Acc +42
Acc +17
Acc -19
Acc +24
jmp -170
Acc +30
Acc +9
Acc -1
jmp -328
Acc +19
Acc +45
jmp +132
nop -244
nop +35
jmp +34
Acc -10
Acc +26
Acc +35
nop -238
jmp +54
Acc +15
nop -378
Acc +42
jmp -43
Acc -9
Acc -5
Acc -11
nop -307
jmp -129
nop -202
Acc -9
nop -376
Acc +11
jmp -75
jmp +14
Acc -1
Acc +32
Acc -14
Acc +16
jmp +39
Acc +42
Acc +32
jmp -133
Acc +1
Acc +17
nop +85
Acc +35
jmp +83
Acc +27
Acc +0
Acc -12
jmp -93
Acc +48
Acc +35
nop +154
jmp -287
jmp -347
jmp -348
Acc +18
jmp -374
Acc -15
jmp +36
jmp -123
Acc -11
jmp +55
Acc +19
Acc +23
jmp -339
nop +5
Acc +44
Acc +2
jmp +1
jmp -417
Acc +23
jmp -253
Acc -9
Acc -3
jmp -138
jmp -227
Acc +12
jmp -437
Acc +47
Acc +19
Acc -6
jmp -245
Acc +2
jmp -328
Acc -14
Acc +25
Acc +4
Acc -2
jmp -411
jmp -351
jmp -459
Acc +3
Acc +48
jmp -134
nop +54
Acc -14
jmp -298
jmp -401
Acc -14
Acc +25
nop -55
Acc -10
jmp -312
Acc -7
Acc +45
jmp -74
Acc +30
jmp -462
Acc +5
Acc -8
jmp -355
Acc +9
Acc +44
Acc +44
jmp -150
jmp -484
Acc +14
Acc +19
Acc -6
jmp -474
Acc -18
jmp -166
jmp -264
Acc -15
Acc +17
Acc +29
jmp -149
nop -273
Acc +31
Acc +0
Acc -2
jmp -410
jmp -411
Acc +47
Acc -6
nop -287
jmp -436
Acc +4
nop +88
jmp -158
Acc +32
jmp +1
Acc -15
jmp -319
Acc -6
Acc -18
Acc +49
jmp -256
Acc -18
Acc +31
Acc +27
Acc +27
jmp -351
jmp +58
Acc +12
jmp +1
Acc +32
nop -151
jmp -411
Acc +19
Acc +7
jmp -287
Acc +30
jmp -496
Acc -11
Acc +5
Acc +42
Acc +25
jmp -249
Acc -1
jmp -243
jmp -190
Acc +32
Acc +32
Acc +14
jmp +12
Acc +5
Acc +30
Acc +34
jmp -46
Acc -13
Acc +5
Acc +45
jmp -271
Acc +29
Acc +37
jmp -323
nop -18
Acc -2
Acc +21
Acc -12
jmp -453
Acc -14
Acc +19
nop -173
jmp -411
Acc +24
Acc -7
nop -136
Acc +6
jmp -357
Acc -1
Acc -1
Acc +32
jmp -264
Acc +26
jmp -175
Acc +10
Acc +35
nop -361
jmp -493
Acc +14
jmp -206
jmp -138
Acc -1
jmp -156
Acc +3
Acc +11
Acc -2
jmp -213
Acc +35
Acc -13
Acc +47
Acc +45
jmp -376
jmp -543
jmp -479
Acc +29
jmp -532
Acc +28
Acc +47
Acc -11
Acc -14
jmp +1").Returns(1501);
        }
    }
}